name: Scrape Clash Codes

on:
  schedule:
    - cron: '0 12 * * *' # tous les midi (UTC)
  workflow_dispatch:    # permet de lancer manuellement

jobs:
  run-scraper:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # pour pouvoir push les changements

    steps:
      # Checkout du repo
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          persist-credentials: true

      # Setup Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      # Installer zbar (pour pyzbar / QR code)
      - name: Install zbar
        run: sudo apt-get update && sudo apt-get install -y libzbar0

      # Installer les d√©pendances Python
      - name: Install dependencies
        run: pip install -r requirements.txt

      # Lancer le scraper Clash of Clans
      - name: Run Clash of Clans scraper
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: python scraper_clashOfClans.py

      # Lancer le scraper Clash Royale
      - name: Run Clash Royale scraper
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: python scraper_clashRoyale.py

      # Debugging: show git status / diff and seen files before auto-commit
      - name: Debug workspace and seen files
        run: |
          echo "--- Workspace files ---"
          ls -la
          echo "--- Seen JSON files ---"
          ls -l seen_*.json || true
          echo "--- Git status (porcelain) ---"
          git status --porcelain || true
          echo "--- Git diff (names) ---"
          git --no-pager diff --name-only || true
          echo "--- seen_clashRoyale.json (head) ---"
          sed -n '1,200p' seen_clashRoyale.json || true

      # Commit et push de seen_clashOfClans.json et seen_clashRoyale.json automatiquement
      - name: Auto commit changes (explicit)
        run: |
          git --version
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add seen_clashOfClans.json seen_clashRoyale.json || true
          echo "Staged files:" && git diff --cached --name-only || true
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update seen files"
            git push origin HEAD:$(echo ${GITHUB_REF#refs/heads/})
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
